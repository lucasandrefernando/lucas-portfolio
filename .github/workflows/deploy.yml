name: Build and Deploy to KingHost

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build

      - name: Deploy via FTPS
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          python3 << 'PYEOF'
          import ftplib, os, io

          host = os.environ['FTP_HOST']
          user = os.environ['FTP_USER']
          password = os.environ['FTP_PASSWORD']
          remote_base = 'apps_nodejs/portfolio'

          print(f"=== Connecting to {host}:21 via FTPS ===")
          ftp = ftplib.FTP_TLS()
          ftp.connect(host, 21, timeout=30)
          ftp.auth()
          ftp.login(user, password)
          ftp.prot_p()
          ftp.set_pasv(True)

          print(f"Connected! pwd: {ftp.pwd()}")
          print("\n=== Root listing ===")
          ftp.dir()

          def mkdir_p(ftp, path):
              parts = path.strip('/').split('/')
              current = ''
              for part in parts:
                  current = f"{current}/{part}" if current else part
                  try:
                      ftp.mkd(current)
                      print(f"Created: {current}")
                  except ftplib.error_perm as e:
                      if '550' in str(e):
                          print(f"Exists (ok): {current}")
                      else:
                          raise

          def upload_dir(ftp, local_dir, remote_dir):
              mkdir_p(ftp, remote_dir)
              for entry in os.scandir(local_dir):
                  remote_path = f"{remote_dir}/{entry.name}"
                  if entry.is_dir():
                      upload_dir(ftp, entry.path, remote_path)
                  else:
                      print(f"Uploading: {remote_path}")
                      with open(entry.path, 'rb') as f:
                          ftp.storbinary(f'STOR {remote_path}', f)

          print(f"\n=== Uploading to {remote_base} ===")
          upload_dir(ftp, 'dist', remote_base)

          ftp.quit()
          print("\n=== Deploy concluido! ===")
          PYEOF

      - name: Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "Deploy concluido com sucesso!"
          else
            echo "Deploy falhou!"
          fi
